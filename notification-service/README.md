# Notification Service

Web Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Kafka, Redis –∏ HTTP API.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **HTTP API** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è VAPID –∫–ª—é—á–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **Kafka Consumer** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏
- **Redis** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Web Push** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–µ—Ä–≤–∏—Å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤ —Å–µ–±–µ:
- HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- Kafka consumer –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- Web Push –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –±—Ä–∞—É–∑–µ—Ä

## üì° HTTP API Endpoints

### GET `/api/v1/vapid-key`
–ü–æ–ª—É—á–∏—Ç—å VAPID –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

**Response:**
```json
{
  "publicKey": "your-vapid-public-key"
}
```

### POST `/api/v1/subscribe`
–ü–æ–¥–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

**Headers:**
- `X-User-ID`: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `Content-Type`: application/json

**Request Body:**
```json
{
  "endpoint": "https://...",
  "keys": {
    "p256dh": "...",
    "auth": "..."
  }
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Subscription successful"
}
```

## üì® Kafka Message Format

Consumer –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "user_uid": "user-123",
  "notification": {
    "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
    "body": "–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
    "data": "–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
  }
}
```

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# HTTP Server
HTTP_HOST=              # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ""
HTTP_PORT=8080          # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 8080

# Kafka
KAFKA_BROKERS=localhost:9092
KAFKA_CONS_TOPIC=notifications
KAFKA_PROD_TOPIC=notifications
KAFKA_CONN_DEADLINE=10s

# Redis
CACHE_HOST=localhost:6379
CACHE_PASSWORD=
CACHE_CONN_DEADLINE=10s

# VAPID –¥–ª—è Web Push
VAPID_PUBLIC=your-vapid-public-key
VAPID_PRIVATE=your-vapid-private-key
VAPID_SUBSCRIBER=mailto:admin@example.com

# Logging
LOG_DEV=false
LOG_CALLER=false
```

## üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
cd notification-service
go run cmd/main.go
```

–°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏—Ç:
- HTTP API –Ω–∞ –ø–æ—Ä—Ç—É 8080 (–∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–º –≤ `HTTP_PORT`)
- Kafka consumer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üì¶ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è easyjson

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å easyjson –∫–æ–¥:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å easyjson (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
go install github.com/mailru/easyjson/...@latest

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
go generate ./internal/models/...
```

## üîÑ Workflow

1. **–ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç VAPID –∫–ª—é—á: `GET /api/vapid-key`
   - –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É: `POST /api/subscribe` —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-User-ID`
   - –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis —Å –∫–ª—é—á–æ–º `webpush:{user_id}`

2. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –î—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Kafka topic
   - Consumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
   - Consumer –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ Redis –ø–æ `user_uid`
   - Consumer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Web Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üõ†Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
notification-service/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ main.go                    # –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (HTTP + Consumer)
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ consumer/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ consumer.go        # Kafka consumer
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.go              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kafka/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ consumer.go        # Kafka –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ log/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ log.go             # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ redis.go           # Redis –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kafka_message.go       # –ú–æ–¥–µ–ª—å Kafka —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.go        # –ú–æ–¥–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stored_subscription.go # –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscription_req.go    # –ú–æ–¥–µ–ª—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ notifications/
‚îÇ       ‚îú‚îÄ‚îÄ controller.go          # HTTP handlers
‚îÇ       ‚îú‚îÄ‚îÄ repository/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ repository.go      # Redis repository
‚îÇ       ‚îî‚îÄ‚îÄ service/
‚îÇ           ‚îú‚îÄ‚îÄ get_vapid_key.go   # –ü–æ–ª—É—á–µ–Ω–∏–µ VAPID –∫–ª—é—á–∞
‚îÇ           ‚îú‚îÄ‚îÄ send_notification.go # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ           ‚îú‚îÄ‚îÄ service.go         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ           ‚îî‚îÄ‚îÄ subscribe_user.go  # –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ go.sum
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ü–æ–¥–ø–∏—Å–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis 30 –¥–Ω–µ–π
- CORS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö origins (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–ª—è production)
- Graceful shutdown –¥–ª—è HTTP –∏ Kafka
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å zap

